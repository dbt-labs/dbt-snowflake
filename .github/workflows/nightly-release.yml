# **what?**
# Nightly releases to GitHub and PyPI. This workflow produces the following outcome:
# - generate and validate data for night release (commit SHA, version number, release branch);
# - pass data to release workflow;
# - night release will be pushed to GitHub as a draft release;
# - night build will be pushed to test PyPI;
#
# **why?**
# Ensure an automated and tested release process for nightly builds
#
# **when?**
# This workflow runs on schedule or can be run manually on demand.

name: Nightly Test Release to GitHub and PyPI
on:
  workflow_dispatch:
  schedule:
    - cron: 0 9 * * *  # daily at 9:00 UTC
permissions:
  contents: write # this is the permission that allows creating a new release
defaults:
  run:
    shell: bash
env:
  RELEASE_BRANCH: "1.7.latest"
jobs:

  release-metadata:
    runs-on: ubuntu-latest
    outputs:
      commit-sha: ${{ steps.package-metadata.outputs.latest-commit-sha }}
      version: ${{ steps.nightly-release-version.outputs.release-version-number }}
    steps:
      - uses: actions/checkout@v3
      - id: package-metadata
        uses: ./.github/actions/branch-package-metadata
        with:
          branch: ${{ env.RELEASE_BRANCH }}
      - id: nightly-release-version
        uses: ./.github/actions/nightly-release-version
        with:
          current-version-number: ${{ steps.package-metadata.current-version-number }}
      - run: |
          echo commit-sha: ${{ needs.aggregate-release-data.outputs.commit-sha }}
          echo version:    ${{ needs.aggregate-release-data.outputs.version }}

  release-github-pypi:
    needs: release-metadata
    uses: ./.github/workflows/release.yml
    with:
      target_branch: ${{ env.RELEASE_BRANCH }}
      sha: ${{ needs.release-metadata.outputs.commit-sha }}
      version_number: ${{ needs.release-metadata.outputs.version }}
      test_run: true
      nightly_release: true
    secrets: inherit
