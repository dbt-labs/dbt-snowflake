# **what?**
# Release workflow provides the following steps:
# - checkout the given commit;
# - validate version in sources and changelog file for given version;
# - bump the version and generate a changelog if needed;
# - merge all changes to the target branch if needed;
# - run unit and integration tests against given commit;
# - build and package that SHA;
# - release it to GitHub and PyPI with that specific build;
#
# **why?**
# Ensure an automated and tested release process
#
# **when?**
# This workflow can be run manually on demand or can be called by other workflows

name: Release to GitHub and PyPI
on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "The branch to release from"
        type: string
        required: true
      version_number:
        description: "The release version number (e.g. 1.0.0b1) defaults to the version on the branch"
        type: string
        required: false
        default: ""
      test_run:
        description: "Test run (Publish release as draft)"
        type: boolean
        required: false
        default: true
      nightly_release:
        description: "Nightly release to dev environment"
        type: boolean
        required: false
        default: false
  workflow_call:
    inputs:
      target_branch:
        description: "The branch to release from"
        type: string
        required: true
      version_number:
        description: "The release version number (e.g. 1.0.0b1) defaults to the version on the branch"
        type: string
        required: false
        default: ""
      test_run:
        description: "Test run (Publish release as draft)"
        type: boolean
        default: true
        required: false
      nightly_release:
        description: "Nightly release to dev environment"
        type: boolean
        default: false
        required: false
permissions:
  contents: write # this is the permission that allows creating a new release
defaults:
  run:
    shell: bash
jobs:

  release-metadata:
    runs-on: ubuntu-latest
    outputs:
      commit-sha: ${{ steps.package-metadata.outputs.latest-commit-sha }}
      version: ${{ steps.release-version.outputs.number }}
    steps:
      - uses: actions/checkout@v3
      - id: package-metadata
        uses: ./.github/actions/branch-package-metadata
        with:
          branch: ${{ inputs.target_branch }}
      - id: release-version
        run: |
          if ${{ inputs.version_number == ''}}; then
            echo "$number=${{ steps.package-metadata.outputs.current-version-number }}" >> $GITHUB_OUTPUT
          else
            echo "$number=${{ inputs.version_number }}" >> $GITHUB_OUTPUT
          fi

  log-inputs:
    name: Log Inputs
    runs-on: ubuntu-latest
    needs: release-metadata
    steps:
      - run: |
          echo The branch to release from:         ${{ inputs.target_branch }}
          echo The last commit sha in the release: ${{ needs.release-metadata.outputs.commit-sha }}
          echo The release version number:         ${{ needs.release-metadata.outputs.version }}
          echo Test run:                           ${{ inputs.test_run }}
          echo Nightly release:                    ${{ inputs.nightly_release }}

  bump-version-generate-changelog:
    name: Bump Package Version, Generate Changelog
    needs: release-metadata
    uses: dbt-labs/dbt-release/.github/workflows/release-prep.yml@main
    with:
      target_branch: ${{ inputs.target_branch }}
      sha: ${{ needs.release-metadata.outputs.commit-sha }}
      version_number: ${{ needs.release-metadata.outputs.version }}
      test_run: ${{ inputs.test_run }}
      nightly_release: ${{ inputs.nightly_release }}
      env_setup_script_path: "scripts/env-setup.sh"
    secrets: inherit

  log-outputs-bump-version-generate-changelog:
    name: Log Outputs
    if: ${{ !failure() && !cancelled() }}
    needs: [bump-version-generate-changelog]
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo Final SHA     : ${{ needs.bump-version-generate-changelog.outputs.final_sha }}
          echo Changelog path: ${{ needs.bump-version-generate-changelog.outputs.changelog_path }}

  build-test-package:
    name: Build, Test, Package
    if: ${{ !failure() && !cancelled() }}
    needs: [bump-version-generate-changelog, release-metadata]
    uses: dbt-labs/dbt-release/.github/workflows/build.yml@main
    with:
      sha: ${{ needs.bump-version-generate-changelog.outputs.final_sha }}
      version_number: ${{ needs.release-metadata.outputs.version }}
      test_run: ${{ inputs.test_run }}
      nightly_release: ${{ inputs.nightly_release }}
      changelog_path: ${{ needs.bump-version-generate-changelog.outputs.changelog_path }}
      build_script_path: "scripts/build-dist.sh"
      s3_bucket_name: "core-team-artifacts"
      package_test_command: "dbt --version"
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  github-release:
    name: GitHub Release
    if: ${{ !failure() && !cancelled() }}
    needs: [bump-version-generate-changelog, build-test-package, release-metadata]
    uses: dbt-labs/dbt-release/.github/workflows/github-release.yml@main
    with:
      sha: ${{ needs.bump-version-generate-changelog.outputs.final_sha }}
      version_number: ${{ needs.release-metadata.outputs.version }}
      test_run: ${{ inputs.test_run }}
      changelog_path: ${{ needs.bump-version-generate-changelog.outputs.changelog_path }}

  pypi-release:
    name: PyPI Release
    needs: [github-release, release-metadata]
    uses: dbt-labs/dbt-release/.github/workflows/pypi-release.yml@main
    with:
      version_number: ${{ needs.release-metadata.outputs.version }}
      test_run: ${{ inputs.test_run }}
    secrets:
      PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      TEST_PYPI_API_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}

  slack-notification:
    name: Slack Notification
    if: ${{ failure() && (!inputs.test_run || inputs.nightly_release) }}
    needs:
      [
        bump-version-generate-changelog,
        build-test-package,
        github-release,
        pypi-release,
      ]
    uses: dbt-labs/dbt-release/.github/workflows/slack-post-notification.yml@main
    with:
      status: "failure"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEV_ADAPTER_ALERTS }}
